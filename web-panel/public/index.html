<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control Panel - Embedded Controller</title>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Font Awesome -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="bg-light py-4">
  
  <!-- MODALS -->
  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="confirmDeleteRuleModal" tabindex="-1" aria-labelledby="confirmDeleteRuleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteRuleModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        Are you sure you want to delete this rule? This action is irreversible.
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteRuleButton">Delete</button>
      </div>

    </div>
  </div>
  </div>

  <!-- STATUS ALERTS -->
  <script>
    function newStatus(alertClass, message) {
      let html = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      return html;
    }
  </script>


  <div class="container">
    <h1 class="mb-4">Embedded Controller Control Panel</h1>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="mainTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-connection" type="button" role="tab">Serial Connection</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-manual" type="button" role="tab">Manual Control</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-graphing" type="button" role="tab">Graphing</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rules" type="button" role="tab">Rules Manager</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-virtual" type="button" role="tab">Virtual Registers</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-hardware" type="button" role="tab">Hardware Configuration</button>
      </li>
    </ul>

    <div class="tab-content mt-3" id="mainTabContent">
      <!-- Serial connection panel -->
      <div class="tab-pane fade show active" id="tab-connection" role="tabpanel">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Serial Connection</h5>
            <a class="btn btn-link" data-bs-toggle="collapse" href="#serialConnectionBody">Toggle</a>
          </div>
          <div class="card-body">
            <div id="serialConnectionBody" class="collapse show">
              <div class="mb-3">
                <label for="portSelect" class="form-label">Select COM Port</label>
                <div class="d-flex">
                  <select id="portSelect" class="form-select me-2">
                    <option>Loading...</option>
                  </select>
                  <button id="refreshPortsBtn" class="btn btn-outline-secondary" title="Refresh ports">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>
              <div class="mb-3">
                <label for="baudSelect" class="form-label">Select Baud Rate</label>
                <select id="baudSelect" class="form-select">
                  <option>9600</option> <!-- hardcoded only option for now -->
                </select>
              </div>
              <div class="mb-3">
                <label for="slaveAddress" class="form-label">Slave Address</label>
                <input type="number" class="form-control" id="slaveAddress" placeholder="Enter slave address (e.g., 1)" min="0" />
              </div>
            </div>
            <button id="connectBtn" class="btn btn-success">Connect</button>
            &nbsp;&nbsp;<div id="connectionStatus" class="mt-2 text-muted d-inline-block"></div>
          </div>
        </div>
        <script>
        // Populate COM port dropdown
        const portSelect = document.getElementById("portSelect");
        const baudSelect = document.getElementById("baudSelect");
        const slaveSelect = document.getElementById("slaveAddress");
        const connectionStatus = document.getElementById("connectionStatus");
        const connectBtn = document.getElementById("connectBtn");
        const refreshPortsBtn = document.getElementById("refreshPortsBtn");

        const connectionStatusDefaultText = 'Select a port and click connect.';
        const noPortsText = "No ports found";

        let isConnected;
        let currentPort; // only required for window.onload
        let currentSlave; // only required for window.onload

        let connectionStatusTimer;
        const connectionStatusTimerInterval = 1000;

        async function getStatus() {
          try {
            const res = await fetch('/status');
            const connected = await res.json();
            isConnected = connected.status;
            currentPort = connected.port;
            currentSlave = connected.slave;
          } catch (exception) {
            isConnected = false; // assume
          }
        }

        async function fetchPorts() {
          try {
            const res = await fetch('/ports');
            const ports = await res.json();

            portSelect.innerHTML = '';
            
            if (ports.length == 0) {
              const option = document.createElement('option');
              option.value = noPortsText;
              option.textContent = noPortsText;
              portSelect.appendChild(option);
            } else {
              ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = port;
                portSelect.appendChild(option);
              });
            }
            
            
            connectionStatus.textContent = connectionStatusDefaultText;
          } catch (exception) {
            portSelect.innerHTML = '<option>Error loading ports</option>';
            connectionStatus.textContent = 'Failed to fetch ports.';
          }
        }

        refreshPortsBtn.addEventListener('click', () => {
          if (!isConnected) {
            fetchPorts();
          }
        });

        function updateUI(connected, port, slave) {
          connectionStatus.classList.remove("text-muted", "text-danger", "text-success");
          if (connected) {
            connectionStatus.textContent = `Connected to ${port}`;
            connectionStatus.classList.add("text-success");
            connectBtn.classList.remove("btn-success");
            connectBtn.classList.add("btn-danger");
            connectBtn.innerText = "Disconnect";
          } else {
            connectionStatus.textContent = `Disconnected from ${port}`;
            connectionStatus.classList.add("text-muted");
            connectBtn.classList.remove("btn-danger");
            connectBtn.classList.add("btn-success");
            connectBtn.innerText = "Connect";
          }

          if (slave !== undefined) {
            slaveSelect.value = slave;
          } 
        }

        connectBtn.addEventListener('click', async () => {
          await getStatus();
          const selectedPort = portSelect.value;
          const selectedBaud = baudSelect.value;
          const selectedSlave = slaveSelect.value;  

          if (selectedPort == noPortsText) {
            connectionStatus.textContent = `No valid port was selected.`;
            connectionStatus.classList.remove("text-muted", "text-success");
            connectionStatus.classList.add("text-danger");
            return;
          }

          if (!isConnected) {
            // Connect
            const res = await fetch(`/connect?port=${encodeURIComponent(selectedPort)}&baud=${encodeURIComponent(selectedBaud)}&slave=${encodeURIComponent(selectedSlave)}`);
            const data = await res.json();

            
            if (data.success) {
              isConnected = true;
              updateUI(true, selectedPort);
              statusPolling(true);
              await ruleListUpdate();
              await vrListUpdate();
              connectionStatusTimer = setInterval(connectionStatus, connectionStatusTimerInterval);
            } else {
              statusPolling(false);
              connectionStatus.textContent = `Failed: ${data.error}`;
              connectionStatus.classList.remove("text-muted", "text-danger");
              connectionStatus.classList.add("text-danger");
              
              connectBtn.classList.remove("btn-danger");
              connectBtn.classList.add("btn-success");
              connectBtn.innerText = "Connect";
            }        
          } else {
            // Disconnect
            const res = await fetch(`/disconnect`);
            const data = await res.json();

            statusPolling(false);

            if (data.success) {
              updateUI(false, selectedPort);
              ruleListUpdate();
              connectionStatusTimer = clearInterval();
            } else {
              connectionStatus.textContent = `Failed to disconnect: ${data.error}`;
              connectionStatus.classList.remove("text-success");
              connectionStatus.classList.add("text-danger");
            }
          }

          // Status polling regularly to check for serial port disconnect
          async function connectionStatus() {
            const isConnectedBuffer = isConnected;
            const portBuffer = currentPort;
            await getStatus();
            if (isConnectedBuffer != isConnected) {
              currentPort = portBuffer; // for disconnect text to be correct
              updateUI(isConnected, currentPort, currentSlave);
              statusPolling(isConnected);
            }
          }

        });
        </script>

        <!-- Status panel -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Status</h5>
            <a class="btn btn-link" data-bs-toggle="collapse" href="#statusBody">Toggle</a>
          </div>
          <div class="card-body">
            <div id="statusBody" class="collapse show">
              <div class="mb-3">
                <a id="statusVoltage">Please initiate a serial connection to view device status.</a><br>
                <a id="statusCurrent"></a>
              </div>
              <div id="statusStatus" class="mt-3"></div>
            </div>
          </div>
        </div>
        <script>
          const statusVoltage = document.getElementById('statusVoltage');
          const statusCurrent = document.getElementById('statusCurrent');
          const statusStatus = document.getElementById('statusStatus');

          const statusVoltageAddress = 4; // current status must be the one after voltage
          const statusVoltageScale = 0.00125; // V
          const statusCurrentScale = 0.00015; // A

          statusVoltageDefaultText = statusVoltage.innerText;

          const statusPollingInterval = 2000; // ms

          let statusTimer;

          async function updateStatus() {
            try {
              const url = `/read?type=input&address=${encodeURIComponent(statusVoltageAddress)}&quantity=2`;
              
              const response = await fetch(url);
              statusStatus.innerHTML = "";
              if (response.ok) {
                const data = await response.json();

                const voltage = data.data[0] * statusVoltageScale;
                const current = data.data[1] * statusCurrentScale * 1000; // * 1000 to mA

                statusVoltage.innerText = "Supply Voltage: " + voltage.toFixed(2) + " V";
                statusCurrent.innerText = "Current Draw: " + current.toFixed(2) + " mA";
              } else {
                statusVoltage.innerText = statusVoltageDefaultText;
                statusCurrent.innerText = "";
                statusStatus.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
              }
            } catch (err) {
                statusStatus.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
            }
          }

          function statusPolling(enable) {
            if (enable) {
              clearInterval(statusTimer);
              statusTimer = setInterval(updateStatus, statusPollingInterval);
            } else {
              statusVoltage.innerText = statusVoltageDefaultText;
              statusCurrent.innerText = "";
              clearInterval(statusTimer);
              statusTimer = null;
            }
          }
        </script>
      </div>

      <!-- Functions control panel -->
      <div class="tab-pane fade" id="tab-manual" role="tabpanel">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Manual Control</h5>
            <a class="btn btn-link" data-bs-toggle="collapse" href="#functionsBody">Toggle</a>
          </div>
          <div class="card-body">
            <div id="functionsBody" class="collapse show">
              <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="coils-tab" data-bs-toggle="tab"
                    data-bs-target="#coils" type="button" role="tab" aria-controls="coils"
                    aria-selected="true">Coils</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="discrete-tab" data-bs-toggle="tab"
                    data-bs-target="#discrete" type="button" role="tab" aria-controls="discrete"
                    aria-selected="true">Discrete Inputs</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="holding-tab" data-bs-toggle="tab"
                    data-bs-target="#holding" type="button" role="tab" aria-controls="holding"
                    aria-selected="true">Holding Registers</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="input-tab" data-bs-toggle="tab"
                    data-bs-target="#input" type="button" role="tab" aria-controls="input"
                    aria-selected="true">Input Registers</button>
                </li>
              </ul>
              <div class="tab-content mt-3" id="myTabContent">
                <div class="tab-pane fade show active" id="coils" role="tabpanel" aria-labelledby="coils-tab">
                  <div class="card">
                    <div class="card-body">
                      <h6>Read Coils (0x01)</h6>
                      <div class="mb-3">
                        <label for="coilAddressR" class="form-label">Coil Address</label>
                        <input type="number" class="form-control" id="coilAddressR" placeholder="Enter coil address (e.g., 0)" min="0" />
                      </div>
                      <div class="mb-3">
                        <label for="coilQuantityR" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="coilQuantityR" placeholder="Enter quantity of coils to read (e.g., 1)" min="1" />
                      </div>

                      <button id="coilSendR" class="btn btn-primary">Read</button>

                      <div id="coilStatusR" class="mt-3"></div>

                      <table id="coilResultTableR" class="table table-bordered">
                        <thead class="table-light">
                          <tr id="coilResultTableR_heading"></tr>
                        </thead>
                        <tbody>
                          <tr id="coilResultTableR_value"></tr>
                        </tbody>
                      </table>
                    </div>

                    <div class="card-body">
                      <h6>Write Single Coil (0x05)</h6>
                      <div class="mb-3">
                        <label for="coilAddressW" class="form-label">Coil Address</label>
                        <input type="number" class="form-control" id="coilAddressW" placeholder="Enter coil address (e.g., 0)" min="0" />
                      </div>

                      <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="coilToggleW" disabled/>
                        <label class="form-check-label" for="coilToggleW">Coil OFF/ON (0/1)</label>
                      </div>

                      <button id="coilSendW" class="btn btn-primary">Write</button>

                      <div id="coilStatusW" class="mt-3"></div>
                    </div>

                    <div class="card-body">
                      <h6>Write Multiple Coils (0x0f)</h6>
                      <div class="mb-3">
                        <label for="coilAddressWM" class="form-label">Coil Address</label>
                        <input type="number" class="form-control" id="coilAddressWM" placeholder="Enter coil address (e.g., 0)" min="0" />
                      </div>
                      <div class="mb-3">
                        <label for="coilQuantityWM" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="coilQuantityWM" placeholder="Enter quantity of coils to write to (e.g., 2)" min="1" />
                      </div>
                      <div id="coilWriteMultipleToggleDiv">
                        <!--<div class="form-check form-switch mb-3">
                          <input class="form-check-input" type="checkbox" id="coilToggleWM" disabled/>
                          <label class="form-check-label" for="coilToggleWM">Coil OFF/ON (0/1)</label>
                        </div>-->
                      </div>
                      <button id="coilSendWM" class="btn btn-primary">Write</button>

                      <div id="coilStatusWM" class="mt-3"></div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade show" id="discrete" role="tabpanel" aria-labelledby="discrete-tab">
                  <div class="card">
                    <div class="card-body">
                      <h6>Read Discrete Inputs (0x02)</h6>
                      <div class="mb-3">
                        <label for="discreteAddressR" class="form-label">Input Address</label>
                        <input type="number" class="form-control" id="discreteAddressR" placeholder="Enter discrete input address (e.g., 0)" min="0" />
                      </div>
                      <div class="mb-3">
                        <label for="discreteQuantityR" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="discreteQuantityR" placeholder="Enter quantity of discrete inputs to read (e.g., 1)" min="1" />
                      </div>

                      <button id="discreteSendR" class="btn btn-primary">Read</button>

                      <div id="discreteStatusR" class="mt-3"></div>

                      <table id="discreteResultTableR" class="table table-bordered">
                        <thead class="table-light">
                          <tr id="discreteResultTableR_heading"></tr>
                        </thead>
                        <tbody>
                          <tr id="discreteResultTableR_value"></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade show" id="holding" role="tabpanel" aria-labelledby="holding-tab">
                  <div class="card">
                    <div class="card-body">
                      <h6>Read Holding Registers (0x03)</h6>
                      <div class="mb-3">
                        <label for="holdingAddressR" class="form-label">Register Address</label>
                        <input type="number" class="form-control" id="holdingAddressR" placeholder="Enter holding register address (e.g., 0)" min="0" />
                      </div>
                      <div class="mb-3">
                        <label for="holdingQuantityR" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="holdingQuantityR" placeholder="Enter quantity of holding registers to read (e.g., 1)" min="1" />
                      </div>

                      <button id="holdingSendR" class="btn btn-primary">Read</button>

                      <div id="holdingStatusR" class="mt-3"></div>

                      <table id="holdingResultTableR" class="table table-bordered">
                        <thead class="table-light">
                          <tr id="holdingResultTableR_heading"></tr>
                        </thead>
                        <tbody>
                          <tr id="holdingResultTableR_value"></tr>
                        </tbody>
                      </table>
                    </div>

                    <div class="card-body">
                      <h6>Write Single Register (0x06)</h6>
                      <div class="mb-3">
                        <label for="holdingAddressW" class="form-label">Register Address</label>
                        <input type="number" class="form-control" id="holdingAddressW" placeholder="Enter holding register address (e.g., 0)" min="0" />
                      </div>
                      <div class="mb-3">
                        <label for="holdingValueW" class="form-label">Value</label>
                        <input type="number" class="form-control" id="holdingValueW" placeholder="Enter value to write (0-65535)" min="0" />
                      </div>

                      <button id="holdingSendW" class="btn btn-primary">Write</button>

                      <div id="holdingStatusW" class="mt-3"></div>
                    </div>

                    <div class="card-body">
                      <h6>Write Multiple Registers (0x10)</h6>
                      <div class="mb-3">
                        <label for="holdingAddressWM" class="form-label">Register Address</label>
                        <input type="number" class="form-control" id="holdingAddressWM" placeholder="Enter holding register address (e.g., 0)" min="0" />
                      </div>
                      <div class="mb-3">
                        <label for="holdingQuantityWM" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="holdingQuantityWM" placeholder="Enter quantity of holding registers to write to (e.g., 2)" min="1" />
                      </div>
                      <div id="holdingWriteMultipleToggleDiv">
                      </div>
                      <button id="holdingSendWM" class="btn btn-primary">Write</button>

                      <div id="holdingStatusWM" class="mt-3"></div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade show" id="input" role="tabpanel" aria-labelledby="input-tab">
                  <div class="card">
                    <div class="card-body">
                      <h6>Read Input Registers (0x04)</h6>
                      <div class="mb-3">
                        <label for="inputAddressR" class="form-label">Input Address</label>
                        <input type="number" class="form-control" id="inputAddressR" placeholder="Enter input register address (e.g., 0)" min="0" />
                      </div>
                      <div class="mb-3">
                        <label for="inputQuantityR" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="inputQuantityR" placeholder="Enter quantity of inputs registers to read (e.g., 1)" min="1" />
                      </div>

                      <button id="inputSendR" class="btn btn-primary">Read</button>

                      <div id="inputStatusR" class="mt-3"></div>

                      <table id="inputResultTableR" class="table table-bordered">
                        <thead class="table-light">
                          <tr id="inputResultTableR_heading"></tr>
                        </thead>
                        <tbody>
                          <tr id="inputResultTableR_value"></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Coil Functions -->
        <script>
        const coilAddressR = document.getElementById('coilAddressR');
        const coilQuantityR = document.getElementById('coilQuantityR');
        const coilSendR = document.getElementById('coilSendR');
        const coilStatusR = document.getElementById('coilStatusR');

        const coilToggleW = document.getElementById('coilToggleW');
        const coilAddressW = document.getElementById('coilAddressW');
        const coilSendW = document.getElementById('coilSendW');
        const coilStatusW = document.getElementById('coilStatusW');
        
        const coilQuantityWM = document.getElementById('coilQuantityWM');
        const coilAddressWM = document.getElementById('coilAddressWM');
        const coilSendWM = document.getElementById('coilSendWM');

        // Enable toggle only when coil address is valid
        coilAddressW.addEventListener('input', () => {
          const val = coilAddressW.value;
          coilToggleW.disabled = !(val !== '' && Number(val) >= 0);
          coilStatusW.textContent = '';
        });

        // Write Single
        async function writeCoil(address, value) {
          try {
            coilStatusW.textContent = 'Sending request...';
            const valInt = value ? 1 : 0;
            const url = `/write?type=coil&address=${encodeURIComponent(address)}&value=${valInt}`;
            
            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
              coilStatusW.innerHTML = newStatus("alert-success", `Coil at address ${address} set to ${valInt}`);
            } else {
              coilStatusW.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
              coilStatusW.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        // Write multiple 
        async function writeMultipleCoils(address, valueArray) {
          try {
            coilStatusWM.textContent = 'Sending request...';
            
            const url = `/write?type=coil&address=${encodeURIComponent(address)}&value=${valueArray}`;

            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
              coilStatusWM.innerHTML = newStatus("alert-success", `Coils starting at address ${address} set to ${valueArray}.`);
            } else {
              coilStatusWM.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
            coilStatusWM.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        // Read
        async function readCoil(address, quantity) {
          try {
            const addr = parseInt(address);
            const quan = parseInt(quantity);

            coilStatusR.textContent = 'Sending request...';
            const url = `/read?type=coil&address=${encodeURIComponent(address)}&quantity=${quantity}`;
            console.log(url);
            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
              coilStatusR.innerHTML = "";
              const coilValues = data.data;

              const headingRow = document.getElementById("coilResultTableR_heading");
              const valueRow = document.getElementById("coilResultTableR_value");

              for (let i = addr; i < addr + quan; i++) {
                // Heading Cell
                const cell = document.createElement('td'); // create a table cell
                cell.textContent = i; // set cell content
                headingRow.appendChild(cell); // add cell to row

                // Value cell
                const cell2 = document.createElement('td');
                cell2.textContent = coilValues[i] ? "ON" : "OFF";
                valueRow.appendChild(cell2);
              }
            } else {
              coilStatusR.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
              coilStatusR.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        // Update WM toggles
        function updateWMToggles() {
          const addr = parseInt(coilAddressWM.value);
          const quan = parseInt(coilQuantityWM.value);
          const workingDiv = document.getElementById("coilWriteMultipleToggleDiv");

          workingDiv.innerHTML = "";
          coilStatusWM.innerHTML = "";

          if (Number(quan) > 256) {
            coilStatusWM.innerHTML = newStatus("alert-warning", `Please enter a quantity less than or equal to 256.`);
            return;
          }

          if (isNaN(quan) || quan < 1 || quan > 256 || isNaN(addr) || addr < 0) {
            return;
          }

          /*<div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="coilToggleWM" disabled/>
            <label class="form-check-label" for="coilToggleWM">Coil OFF/ON (0/1)</label>
          </div>*/

          workingDiv.innerHTML = "<h6>Coil OFF/ON (0/1)</h6>";

          for (var i = addr; i < addr + quan; i++) {
            const id = `coilToggleWM-${i}`;
            
            const formDiv = document.createElement("div");
            formDiv.className = "form-check form-switch mb-3";
            
            const input = document.createElement("input");
            input.className = "form-check-input";
            input.type = "checkbox";
            input.id = id;
            
            const label = document.createElement("label");
            label.className = "form-check-label";
            label.setAttribute("for", id);
            label.textContent = `Coil ${i}`;

            formDiv.appendChild(input);
            formDiv.appendChild(label);

            workingDiv.appendChild(formDiv);
          }
        }

        coilSendW.addEventListener('click', () => {
          const addr = coilAddressW.value;
          if (addr === '' || Number(addr) < 0) {
            coilStatusW.innerHTML = newStatus("alert-warning", `Please enter a valid coil address (0 or higher).`);
            return;
          }
          const val = coilToggleW.checked;
          writeCoil(addr, val);
        });

        coilSendWM.addEventListener('click', () => {
          const address = parseInt(coilAddressWM.value);
          const quantity = parseInt(coilQuantityWM.value);

          if (isNaN(address) || address < 0) {
            coilStatusWM.innerHTML = newStatus("alert-warning", `Please enter a valid coil address (0 or higher).`);
            return;
          }
          if (isNaN(quantity) || quantity < 1) {
            coilStatusWM.innerHTML = newStatus("alert-warning", `Please enter a valid quantity to write (1 or higher).`);
            return;
          }

          const valueArray = [];
          for (var i = address; i < address + quantity; i++) {
            const toggleElement = document.getElementById(`coilToggleWM-${i}`);
            const toggleValue = toggleElement.checked ? 1 : 0;
            valueArray.push(toggleValue);
          }

          writeMultipleCoils(address, valueArray); // handles value gathering in here
        });

        coilSendR.addEventListener('click', () => {
          const addr = coilAddressR.value;
          const quan = coilQuantityR.value;

          const headingRow = document.getElementById("coilResultTableR_heading");
          const valueRow = document.getElementById("coilResultTableR_value");
          headingRow.innerHTML = "";
          valueRow.innerHTML = "";

          if (addr === '' || Number(addr) < 0) {
            coilStatusR.innerHTML = newStatus("alert-warning", `Please enter a valid coil address (0 or higher).`);
            return;
          }
          if (quan === '' || Number(quan) < 1) {
            coilStatusR.innerHTML = newStatus("alert-warning", `Please enter a valid quantity to read (1 or higher).`);
            return;
          }
          readCoil(addr, quan);
        });

        coilQuantityWM.addEventListener('input', () => {
          updateWMToggles();
        });

        coilAddressWM.addEventListener('input', () => {
          updateWMToggles();
        });
        </script>

        <!-- Discrete Functions -->
        <script>
        const discreteAddressR = document.getElementById('discreteAddressR');
        const discreteSendR = document.getElementById('discreteSendR');
        const discreteStatusR = document.getElementById('discreteStatusR');
        
        // Read
        async function readDiscrete(address, quantity) {
          try {
            const addr = parseInt(address);
            const quan = parseInt(quantity);

            discreteStatusR.textContent = 'Sending request...';
            const url = `/read?type=discrete&address=${encodeURIComponent(address)}&quantity=${quantity}`;
            console.log(url);
            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
              discreteStatusR.innerHTML = "";
              const discreteValues = data.data;

              const headingRow = document.getElementById("discreteResultTableR_heading");
              const valueRow = document.getElementById("discreteResultTableR_value");

              for (let i = addr; i < addr + quan; i++) {
                // Heading Cell
                const cell = document.createElement('td'); // create a table cell
                cell.textContent = i; // set cell content
                headingRow.appendChild(cell); // add cell to row

                // Value cell
                const cell2 = document.createElement('td');
                cell2.textContent = discreteValues[i - addr] ? "ON" : "OFF";
                valueRow.appendChild(cell2);
              }
            } else {
              discreteStatusR.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
              discreteStatusR.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        discreteSendR.addEventListener('click', () => {
          const addr = discreteAddressR.value;
          const quan = discreteQuantityR.value;

          const headingRow = document.getElementById("discreteResultTableR_heading");
          const valueRow = document.getElementById("discreteResultTableR_value");
          headingRow.innerHTML = "";
          valueRow.innerHTML = "";

          if (addr === '' || Number(addr) < 0) {
            discreteStatusR.innerHTML = newStatus("alert-warning", `Please enter a valid discrete input address (0 or higher).`);
            return;
          }
          if (quan === '' || Number(quan) < 1) {
            discreteStatusR.innerHTML = newStatus("alert-warning", `Please enter a valid quantity to read (1 or higher).`);
            return;
          }
          readDiscrete(addr, quan);
        });
        </script>

        <!-- Holding Functions -->
        <script>
        const holdingAddressR = document.getElementById('holdingAddressR');
        const holdingQuantityR = document.getElementById('holdingQuantityR');
        const holdingSendR = document.getElementById('holdingSendR');
        const holdingStatusR = document.getElementById('holdingStatusR');

        const holdingValueW = document.getElementById('holdingValueW');
        const holdingAddressW = document.getElementById('holdingAddressW');
        const holdingSendW = document.getElementById('holdingSendW');
        const holdingStatusW = document.getElementById('holdingStatusW');

        const holdingAddressWM = document.getElementById('holdingAddressWM');
        const holdignSendWM = document.getElementById('holdingSendWM');
        const holdingStatusWM = document.getElementById('holdingStatusWM');

        // Write Single
        async function writeHolding(address, value) {
          try {
            holdingStatusW.textContent = 'Sending request...';
            const url = `/write?type=holding&address=${encodeURIComponent(address)}&value=${encodeURIComponent(value)}`;
            
            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
              holdingStatusW.innerHTML = newStatus("alert-success", `Holding register at address ${address} set to ${value}.`);
            } else {
              holdingStatusW.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
              holdingStatusW.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        // Write multiple 
        async function writeMultipleHolding(address, valueArray) {
          try {
            holdingStatusWM.textContent = 'Sending request...';
            
            const url = `/write?type=holding&address=${encodeURIComponent(address)}&value=${valueArray}`;

            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
              holdingStatusWM.innerHTML = newStatus("alert-success", `Holding registers starting at address ${address} set to ${valueArray}.`);
            } else {
              holdingStatusWM.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
            holdingStatusWM.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        // Read
        async function readHolding(address, quantity) {
          try {
            const addr = parseInt(address);
            const quan = parseInt(quantity);

            holdingStatusR.textContent = 'Sending request...';
            const url = `/read?type=holding&address=${encodeURIComponent(address)}&quantity=${quantity}`;
            console.log(url);
            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
              holdingStatusR.innerHTML = "";
              const holdingValues = data.data;

              const headingRow = document.getElementById("holdingResultTableR_heading");
              const valueRow = document.getElementById("holdingResultTableR_value");

              for (let i = addr; i < addr + quan; i++) {
                // Heading Cell
                const cell = document.createElement('td'); // create a table cell
                cell.textContent = i; // set cell content
                headingRow.appendChild(cell); // add cell to row

                // Value cell
                const cell2 = document.createElement('td');
                cell2.textContent = holdingValues[i];
                valueRow.appendChild(cell2);
              }
            } else {
              holdingStatusR.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
              holdingStatusR.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        // Update WM inputs
        function updateWMInputs() {
          const addr = parseInt(holdingAddressWM.value);
          const quan = parseInt(holdingQuantityWM.value);
          const workingDiv = document.getElementById("holdingWriteMultipleToggleDiv");

          workingDiv.innerHTML = "";
          holdingStatusWM.innerHTML = "";

          if (Number(quan) > 256) {
            holdingStatusWM.innerHTML = newStatus("alert-warning", `Please enter a quantity less than or equal to 256.`);
            return;
          }

          if (isNaN(quan) || quan < 1 || quan > 256 || isNaN(addr) || addr < 0) {
            return;
          }

          /*<div class="mb-3">
            <label for="holdingValueW" class="form-label">Value</label>
            <input type="number" class="form-control" id="holdingValueW" placeholder="Enter value to write (0-65535)" min="0" />
          </div>*/

          workingDiv.innerHTML = "<h6>Holding Register (Value 0-65535)</h6>";

          for (var i = addr; i < addr + quan; i++) {
            const id = `holdingInput-${i}`;
            
            const formDiv = document.createElement("div");
            formDiv.className = "mb-3 d-flex align-items-center";

            const label = document.createElement("label");
            label.className = "me-2"; // right margin
            label.setAttribute("for", id);
            label.textContent = `Register ${i}`;
            
            const input = document.createElement("input");
            input.className = "form-control";
            input.style.width = "120px";
            input.type = "number";
            input.id = id;
            input.min = "0";

            formDiv.appendChild(label);
            formDiv.appendChild(input);

            workingDiv.appendChild(formDiv);
          }
        }

        holdingSendW.addEventListener('click', () => {
          const addr = holdingAddressW.value;
          if (addr === '' || Number(addr) < 0) {
            holdingStatusW.innerHTML = newStatus("alert-warning", `Please enter a valid holding register address (0 or higher).`);
            return;
          }
          const val = holdingValueW.value;
          writeHolding(addr, val);
        });

        holdingSendWM.addEventListener('click', () => {
          const address = parseInt(holdingAddressWM.value);
          const quantity = parseInt(holdingQuantityWM.value);

          if (isNaN(address) || address < 0) {
            holdingStatusWM.innerHTML = newStatus("alert-warning", `Please enter a valid holding register address (0 or higher).`);
            return;
          }
          if (isNaN(quantity) || quantity < 1) {
            holdingStatusWM.innerHTML = newStatus("alert-warning", `Please enter a valid quantity to write (1 or higher).`);
            return;
          }

          const valueArray = [];
          for (var i = address; i < address + quantity; i++) {
            const inputElement = document.getElementById(`holdingInput-${i}`);
            const inputValue = inputElement.value;
            valueArray.push(inputValue);
          }

          writeMultipleHolding(address, valueArray); // handles value gathering in here
        });

        holdingSendR.addEventListener('click', () => {
          const addr = holdingAddressR.value;
          const quan = holdingQuantityR.value;

          const headingRow = document.getElementById("holdingResultTableR_heading");
          const valueRow = document.getElementById("holdingResultTableR_value");
          headingRow.innerHTML = "";
          valueRow.innerHTML = "";

          if (addr === '' || Number(addr) < 0) {
            holdingStatusR.innerHTML = newStatus("alert-warning", `Please enter a valid holding register address (0 or higher).`);
            return;
          }
          if (quan === '' || Number(quan) < 1) {
            holdingStatusR.innerHTML = newStatus("alert-warning", `Please enter a valid quantity to read (1 or higher).`);
            return;
          }
          readHolding(addr, quan);
        });

        holdingQuantityWM.addEventListener('input', () => {
          updateWMInputs();
        });

        holdingAddressWM.addEventListener('input', () => {
          updateWMInputs();
        });
        </script>

        <!-- Input Functions -->
        <script>
        const inputAddressR = document.getElementById('inputAddressR');
        const inputSendR = document.getElementById('inputSendR');
        const inputStatusR = document.getElementById('inputStatusR');
        
        // Read
        async function readInput(address, quantity) {
          try {
            const addr = parseInt(address);
            const quan = parseInt(quantity);

            inputStatusR.textContent = 'Sending request...';
            const url = `/read?type=input&address=${encodeURIComponent(address)}&quantity=${quantity}`;
            console.log(url);
            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
              inputStatusR.innerHTML = "";
              const inputValues = data.data;

              const headingRow = document.getElementById("inputResultTableR_heading");
              const valueRow = document.getElementById("inputResultTableR_value");

              for (let i = addr; i < addr + quan; i++) {
                // Heading Cell
                const cell = document.createElement('td'); // create a table cell
                cell.textContent = i; // set cell content
                headingRow.appendChild(cell); // add cell to row

                // Value cell
                const cell2 = document.createElement('td');
                cell2.textContent = inputValues[i - addr];
                valueRow.appendChild(cell2);
              }
            } else {
              inputStatusR.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
              inputStatusR.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        inputSendR.addEventListener('click', () => {
          const addr = inputAddressR.value;
          const quan = inputQuantityR.value;

          const headingRow = document.getElementById("inputResultTableR_heading");
          const valueRow = document.getElementById("inputResultTableR_value");
          headingRow.innerHTML = "";
          valueRow.innerHTML = "";

          if (addr === '' || Number(addr) < 0) {
            inputStatusR.innerHTML = newStatus("alert-warning", `Please enter a valid input register address (0 or higher).`);
            return;
          }
          if (quan === '' || Number(quan) < 1) {
            inputStatusR.innerHTML = newStatus("alert-warning", `Please enter a valid quantity to read (1 or higher).`);
            return;
          }
          readInput(addr, quan);
        });
        </script>
      </div>
      <div class="tab-pane fade" id="tab-graphing" role="tabpanel">
        <!-- Graphing panel -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Graphing</h5>
            <a class="btn btn-link" data-bs-toggle="collapse" href="#graphingBody">Toggle</a>
          </div>
          <div class="card-body">
            <div id="graphingBody" class="collapse show">
              <div>
                <!-- Register select, graph address, graph quantity not active yet -->
                <div class="mb-3">
                  <label for="registerSelect" class="form-label">Select Register Type:</label>
                  <select id="registerSelect" class="form-select">
                    <option>Coil</option>
                    <option>Discrete Input</option>
                    <option>Holding Register</option>
                    <option>Input Register</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="graphAddress" class="form-label">Address:</label>
                  <input type="number" class="form-control" id="graphAddress" placeholder="Enter register address (e.g., 0)" min="0" />
                </div>
                <!--<div class="mb-3">
                  <label for="graphQuantity" class="form-label">Quantity:</label>
                  <input type="number" class="form-control" id="graphQuantity" placeholder="Enter quantity of registers to read (e.g., 1)" min="1" />
                </div>-->

                <button id="addGraphingItem" class="btn btn-primary">Add</button>&nbsp;&nbsp;
                <button id="removeGraphingItem" class="btn btn-danger">Remove</button>
                <div id="addGraphingItemStatus" class="mt-3"></div>
                <div id="removeGraphingItemStatus" class="mt-3"></div>

                <br>
                <div id="graphStatus" class="mt-3"></div>


                <div class="card-body">
                  <canvas id="registerChart" height="100"></canvas>
                </div>

                <div class="mb-3">
                  Polling Interval: 
                  <input type="number" id="intervalInput" class="form-control d-inline-block" style="width: 80px;" value="5"> s&nbsp;&nbsp;
                  <button id="chartStartStop" class="btn btn-success">Start</button>&nbsp;&nbsp;
                  <button id="chartResetZoom" class="btn btn-secondary">Reset Zoom</button>&nbsp;&nbsp;
                  <button id="chartExport" class="btn btn-secondary">Export to CSV</button>
                </div>
                
              </div> 
            </div>
          </div>
        </div>
        <script>
          const addGraphingItem = document.getElementById('addGraphingItem');
          const removeGraphingItem = document.getElementById('removeGraphingItem');
          const addGraphingItemStatus = document.getElementById('addGraphingItemStatus');
          const removeGraphingItemStatus = document.getElementById('removeGraphingItemStatus');

          const chartStartStop = document.getElementById('chartStartStop');
          const chartResetZoom = document.getElementById('chartResetZoom');
          const chartExport = document.getElementById('chartExport');

          const addType = document.getElementById('registerSelect');
          const addAddress = document.getElementById('graphAddress');

          const context = document.getElementById("registerChart").getContext("2d");

          const chart = new Chart(context, {
            type: 'line',
            data: {
              datasets: []
            },
            options: {
              responsive: true,
              animation: true,
              parsing: false,
              scales: {
                //x: { title: { display: true, text: 'Time' }},
                //y: { title: { display: true, text: 'Value' }}
                x: {
                  type: 'time',
                  time: {
                    unit: 'second',
                    tooltipFormat: 'HH:mm:ss'
                  },
                  title: { display: true, text: 'Time' },
                  ticks: {
                    autoSkip: false,
                    source: 'auto'
                  },
                  adapters: {
                    date: luxon.DateTime
                  },
                  min: Date.now() - 60000, // show past 60 seconds
                  max: Date.now()
                },
                /*y: {
                  title: { display: true, text: 'Value' }
                }*/
                yDigital: {
                  type: 'linear',
                  position: 'left',
                  min: 0,
                  max: 1,
                  title: {
                    display: true,
                    text: 'Digital'
                  },
                  grid: {
                    drawOnChartArea: false, // avoid grid overlap
                    drawTicks: false,
                    drawBorder: false,
                  },
                },
                yAnalogue: {
                  type: 'linear',
                  position: 'right',
                  //min: 0,
                  //max: 65535,
                  title: {
                    display: true,
                    text: 'Analogue'
                  },
                  grid: {
                    drawTicks: true,
                    drawBorder: true,
                    drawOnChartArea: true,
                  },
                }
              },
              plugins: {
                zoom: {
                  pan: {
                    enabled: true,
                    mode: 'x',
                    modifierKey: 'ctrl'  // Optional
                  },
                  zoom: {
                    wheel: {
                      enabled: true
                    },
                    pinch: {
                      enabled: true
                    },
                    mode: 'x'
                  }
                }
              },
              tooltip: {
                enabled: true,
                mode: 'nearest',
                intersect: false,
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const yValue = context.parsed.y;
                    return `${label}: ${yValue}`;
                  }
                }
              }
            }
          });

          let timer;
          let addressToRead = 0; // SET ADDRESS
          let quantity = 1;

          async function fetchRegisterAndUpdateChart() {
            // Stop status polling as to not interfere with graphing requests
            await statusPolling(false);

            addGraphingItemStatus.innerHTML = ""; 

            try {
              for (const dataset of chart.data.datasets) {
                const address = dataset.address;
                const type = dataset.regType;

                const res = await fetch(`/read?type=${type}&address=${encodeURIComponent(address)}`);
                const data = await res.json();

                if (res.ok && data.data?.[0] !== undefined) {
                  dataset.data.push({
                    x: Date.now(),
                    y: data.data[0]
                  });
                } else {
                  addGraphingItemStatus.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
                  return;
                }
              }
              chart.options.scales.x.min = Date.now() - 60000;
              chart.options.scales.x.max = Date.now();
              chart.update();
            } catch (err) {
              addGraphingItemStatus.innerHTML = newStatus("alert-danger", `Error: ${err.message}`);
              console.error("Chart update error:", err);
            }

            // restart
            await statusPolling(true);
          }

          function startPolling() {
            clearInterval(timer);
            const intervalSec = parseInt(document.getElementById('intervalInput').value || 5);
            if (intervalSec < 1) {
              graphStatus.innerHTML = newStatus("alert-warning", `Please enter a interval greater than or equal to 1 second.`);
              return;
            }

            if (chart.data.datasets.length === 0) {
              graphStatus.innerHTML = newStatus("alert-warning", `Please add a dataset to the graph.`);
              return;
            }

            graphStatus.innerHTML = "";
            timer = setInterval(fetchRegisterAndUpdateChart, intervalSec * 1000);

            // Change start to stop button
            chartStartStop.innerText = "Stop";
            chartStartStop.classList.remove("btn-success");
            chartStartStop.classList.add("btn-danger");
          }

          function endPolling() {
            clearInterval(timer);
            timer = null;

            // Change stop to start button
            chartStartStop.innerText = "Start";
            chartStartStop.classList.remove("btn-danger");
            chartStartStop.classList.add("btn-success");
          }

          function getRandomColour() {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            return `rgba(${r}, ${g}, ${b}, 1)`;
          }

          addGraphingItem.addEventListener('click', async () => {
            addGraphingItemStatus.innerHTML = "";
            removeGraphingItemStatus.innerHTML = "";

            let type;
            switch (addType.value) {
              case "Coil":
                type = "coil";
                break;
              case "Discrete Input":
                type = "discrete";
                break;
              case "Holding Register":
                type = "holding";
                break;
              case "Input Register":
                type = "input";
                break;
              default:
                addGraphingItemStatus.innerHTML = newStatus("alert-warning", `Please select a valid register type.`);
                return;
            }

            const address = addAddress.value;

            // Check and test validity
            if (address === '' || Number(address) < 0) {
              addGraphingItemStatus.innerHTML = newStatus("alert-warning", `Please enter a valid register address (0 or higher).`);
              return;
            }

            try {
              const url = `/read?type=${type}&address=${encodeURIComponent(address)}`;
              const res = await fetch(url);
              const data = await res.json();
              if (!res.ok) {
                addGraphingItemStatus.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
                return;
              }
            } catch (err) {
              addGraphingItemStatus.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
              return;
            }

            const yAxisID = (type === 'coil' || type === 'discrete') ? 'yDigital' : 'yAnalogue';

            // Create new dataset
            const newDataset = {
              label: `${addType.value} ${address}`,
              regType: type,
              address: parseInt(address), 
              data: [],
              borderColor: getRandomColour(),
              tension: 0.2,
              fill: false,
              yAxisID: yAxisID
            };

            // Push to chart
            chart.data.datasets.push(newDataset);
            chart.update();

            // Reset state
            addAddress.value = "";

            // Start polling
            startPolling();
          });

          removeGraphingItem.addEventListener('click', () => {
              removeGraphingItemStatus.innerHTML = "";

              let type;
              switch (addType.value) {
                case "Coil":
                  type = "coil";
                  break;
                case "Discrete Input":
                  type = "discrete";
                  break;
                case "Holding Register":
                  type = "holding";
                  break;
                case "Input Register":
                  type = "input";
                  break;
                default:
                  removeGraphingItemStatus.innerHTML = newStatus("alert-warning", `Please select a valid register type.`);
                  return;
              }

              const address = parseInt(addAddress.value);

              if (isNaN(address) || address < 0) {
                removeGraphingItemStatus.innerHTML = newStatus("alert-warning", `Please enter a valid register address (0 or higher).`);
                return;
              }

              // Label for comparsion (to find one to delete)
              const labelToRemove = `${addType.value} ${address}`;

              // Find dataset index
              const index = chart.data.datasets.findIndex(ds => ds.label === labelToRemove);

              if (index !== -1) {
                chart.data.datasets.splice(index, 1); // Remove the dataset

                if (chart.data.datasets.length === 0) {
                  endPolling();
                }

                chart.update();
              } else {
                removeGraphingItemStatus.innerHTML = newStatus("alert-info", `Dataset not found.`);
              }

              addAddress.value = "";
          });

          document.getElementById('intervalInput').addEventListener('change', () => {
            if (chart.data.datasets.length > 0 && (timer)) { 
              startPolling();          
            } else {
              endPolling();
            }
          });

          chartStartStop.addEventListener('click', () => {
            if (chartStartStop.innerText == 'Start') {
              startPolling();
            } else {
              endPolling();
            }
          });

          chartResetZoom.addEventListener('click', () => {
            chart.resetZoom();
          });

          chartExport.addEventListener('click', () => {
            let csvContent = "data:text/csv;charset=utf-8,";

            chart.data.datasets.forEach(dataset => {
              csvContent += `\nDataset: ${dataset.label}\nTime,Value\n`;
              dataset.data.forEach(point => {
                const timestamp = new Date(point.x).toISOString();
                csvContent += `${timestamp},${point.y}\n`;
              });
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'export.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });
        </script>
      </div>
      <div class="tab-pane fade" id="tab-rules" role="tabpanel">
        <!-- Rules Manager -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Rules Manager</h5>
            <a class="btn btn-link" data-bs-toggle="collapse" href="#rulesBody">Toggle</a>
          </div>
          <div id="rulesBody" class="collapse show">
            <div class="card m-3">
              <div class="card-body">
                <div class="mb-3">
                  <h6>Statistics</h6>
                  <span id="ruleCount">Unknown Rules</span>
                </div>
              </div>
            </div>
            <div class="card m-3">
              <div class="card-body">
                <div id="rulesDesignerBody" class="collapse show">
                  <div class="mb-3">
                    <h6>Rule Designer</h6>
                  </div>
                  <button id="ruleNew" class="btn btn-primary d-inline-block">New Rule</button>

                  <!-- New Rule If 1 -->
                  <div id="ruleNewIf1" class="mb-3 d-none">
                    <span class="me-2">If</span>

                    <div class="d-inline-block me-2" style="width: 150px;">
                      <select id="inputType1" class="form-select form-select-sm">
                        <option>Select</option>
                        <option>Coil</option>
                        <option>Discrete Input</option>
                        <option>Holding Register</option>
                        <option>Input Register</option>
                        <option>Virtual Coil</option>
                        <option>Virtual Holding Register</option>
                      </select>
                    </div>

                    <div class="d-inline-block me-2" style="width: 100px;">
                      <input type="number" class="form-control form-control-sm" id="inputRegister1" placeholder="address" min="0" />
                    </div>

                    <div class="d-inline-block me-2" style="width: 85px;">
                      <select id="op1" class="form-select form-select-sm">
                        <option>Select</option>
                        <option>==</option>
                        <option>!=</option>
                        <option>></option>
                        <option><</option>
                        <option>>=</option>
                        <option><=</option>
                      </select>
                    </div>

                    <div class="d-inline-block me-2" style="width: 100px;">
                      <input type="number" class="form-control form-control-sm" id="compareValue1" placeholder="value" min="0" />
                    </div>
                    
                    <!-- join -->
                    <div id="ruleJoinDiv" class="d-inline-block me-2 d-none" style="width: 80px;">
                      <select id="ruleJoin" class="form-select form-select-sm">
                        <option>And</option>
                        <option>Or</option>
                      </select>
                    </div>

                    <button id="ruleAddJoin" class="btn btn-primary d-inline-block">Add Join</button>&nbsp;&nbsp;
                  </div>

                  <!-- New Rule If 2 -->
                  <div id="ruleNewIf2" class="mb-3 d-none">

                    <span class="me-2">If</span>

                    <div class="d-inline-block me-2" style="width: 150px;">
                      <select id="inputType2" class="form-select form-select-sm">
                        <option>Select</option>
                        <option>Coil</option>
                        <option>Discrete Input</option>
                        <option>Holding Register</option>
                        <option>Input Register</option>
                        <option>Virtual Coil</option>
                        <option>Virtual Holding Register</option>
                      </select>
                    </div>

                    <div class="d-inline-block me-2" style="width: 100px;">
                      <input type="number" class="form-control form-control-sm" id="inputRegister2" placeholder="address" min="0" />
                    </div>

                    <div class="d-inline-block me-2" style="width: 85px;">
                      <select id="op2" class="form-select form-select-sm">
                        <option>Select</option>
                        <option>==</option>
                        <option>!=</option>
                        <option>></option>
                        <option><</option>
                        <option>>=</option>
                        <option><=</option>
                      </select>
                    </div>

                    <div class="d-inline-block me-2" style="width: 100px;">
                      <input type="number" class="form-control form-control-sm" id="compareValue2" placeholder="value" min="0" />
                    </div>
                  </div>

                  <!-- New Rule Then -->
                  <div id="ruleNewOutput"class="mb-3 d-none">
                    <span class="me-2">Then set</span>

                    <div class="d-inline-block me-2" style="width: 150px;">
                      <select id="outputType" class="form-select form-select-sm">
                        <option>Select</option>
                        <option>Coil</option>
                        <option>Holding Register</option>
                        <option>Virtual Coil</option>
                        <option>Virtual Holding Register</option>
                      </select>
                    </div>

                    <div class="d-inline-block me-2" style="width: 100px;">
                      <input type="number" class="form-control form-control-sm" id="outputRegister" placeholder="address" min="0" />
                    </div>

                    <span class="me-2">to</span>

                    <div class="d-inline-block me-2" style="width: 100px;">
                      <input type="number" class="form-control form-control-sm" id="outputValue" placeholder="value" min="0" />
                    </div>
                  </div>
      
                  <div id="rulePreviewArea" class="d-none mb-3">
                    <label for="rulePreview" class="form-label">Rule Preview:</label>
                    <textarea id="rulePreview" class="form-control" rows="6" readonly></textarea>
                  </div>

                  <div>
                    <button id="ruleSubmit" class="btn btn-success d-inline-block d-none me-1">Add Rule</button>
                    <button id="ruleCancel" class="btn btn-danger d-inline-block d-none">Discard</button>
                  </div>

                  <div id="ruleStatus" class="mt-3"></div>

                </div>
              </div>
            </div>

            <div class="card m-3">
              <div class="card-body">
                <div id="activeRulesBody" class="collapse show">
                  <div class="mb-3">
                    <h6>Active Rules</h6>
                  </div>

                  <div class="list-group mb-3" id="ruleList">
                    <!-- dynamically updated-->
                  </div>

                  <div id="ruleListViewArea" class="d-none mb-3">
                    <label id="ruleListViewAreaLabel" for="ruleListViewAreaContent" class="form-label">Rule:</label>
                    <textarea id="ruleListViewAreaContent" class="form-control" rows="6" readonly></textarea>
                  </div>

                  <button id="ruleListRefresh" class="btn btn-primary d-inline-block">Refresh</button>
                  <button id="ruleListRefreshBusy" class="btn btn-secondary d-inline-block d-none">Refresh</button>

                  <button id="ruleListDelete" class="btn btn-danger d-inline-block d-none">Delete</button>

                  <div id="ruleListStatus" class="mt-3"></div>
                </div>
              </div>
            </div>
            <script>
              const inputType1 = document.getElementById("inputType1");
              const inputType2 = document.getElementById("inputType2");
              const inputRegister1 = document.getElementById("inputRegister1");
              const inputRegister2 = document.getElementById("inputRegister2");
              const op1 = document.getElementById("op1");
              const op2 = document.getElementById("op2");
              const compareValue1 = document.getElementById("compareValue1");
              const compareValue2 = document.getElementById("compareValue2");
              const outputType = document.getElementById("outputType");
              const outputRegister = document.getElementById("outputRegister");
              const outputValue = document.getElementById("outputValue");

              const rulePreview = document.getElementById("rulePreview");
              const rulePreviewArea = document.getElementById("rulePreviewArea");

              const ruleNew = document.getElementById('ruleNew');
              const ruleNewIf1 = document.getElementById('ruleNewIf1');
              const ruleJoin = document.getElementById('ruleJoin');
              const ruleJoinDiv = document.getElementById('ruleJoinDiv');
              const ruleNewIf2 = document.getElementById('ruleNewIf2');
              const ruleNewOutput = document.getElementById('ruleNewOutput');

              const ruleAddJoin = document.getElementById('ruleAddJoin');
              const ruleSubmit = document.getElementById('ruleSubmit');

              const ruleStatus = document.getElementById('ruleStatus');

              const ruleCount = document.getElementById('ruleCount');

              const ruleList = document.getElementById('ruleList');
              const ruleListRefresh = document.getElementById('ruleListRefresh');
              const ruleListRefreshBusy = document.getElementById('ruleListRefreshBusy');
              const ruleListViewArea = document.getElementById('ruleListViewArea');
              const ruleListViewAreaLabel = document.getElementById('ruleListViewAreaLabel');
              const ruleListViewAreaContent = document.getElementById('ruleListViewAreaContent');
              const ruleListStatus = document.getElementById('ruleListStatus');

              const ruleCancel = document.getElementById('ruleCancel');

              const ruleListDelete = document.getElementById('ruleListDelete');
              const confirmDeleteRuleButton = document.getElementById('confirmDeleteRuleButton');
              const modalRTD = new bootstrap.Modal(document.getElementById('confirmDeleteRuleModal'));

              let ruleToDelete = null;

              let joinActive = false;
              let ruleCountNum = 0;
              let ruleListArray = [];

              function getTypeString(type) {
                switch (type) {
                  case "Coil": return "coil";
                  case "Discrete Input": return "discrete";
                  case "Holding Register": return "holding";
                  case "Input Register": return "input";
                  case "Virtual Coil": return "vir_coil";
                  case "Virtual Holding Register": return "vir_holding";
                  default: return "null";
                }
              }

              function getOperationString(operation) {
                switch (operation) {
                  case "==": return "CMP_EQ";
                  case "!=": return "CMP_NEQ";
                  case ">": return "CMP_GT";
                  case "<": return "CMP_LT";
                  case ">=": return "CMP_GTET";
                  case "<=": return "CMP_LTET";
                  default: return "null";
                }
              }

              function updateRulePreview() {
                let preview;
                if (joinActive) {
                  preview = `rule = (LogicRule){\n\tREG_${getTypeString(inputType1.value).toUpperCase()}, ${inputRegister1.value}, ${getOperationString(op1.value)}, ${compareValue1.value},\n\tREG_${getTypeString(inputType2.value).toUpperCase()}, ${inputRegister2.value}, ${getOperationString(op2.value)}, ${compareValue2.value},\n\tLOGIC_${ruleJoin.value.toUpperCase()},\n\tREG_${getTypeString(outputType.value).toUpperCase()}, ${outputRegister.value}, ${outputValue.value}\n};`;
                } else {
                  preview = `rule = (LogicRule){\n\tREG_${getTypeString(inputType1.value).toUpperCase()}, ${inputRegister1.value}, ${getOperationString(op1.value)}, ${compareValue1.value},\n\tREG_${getTypeString(outputType.value).toUpperCase()}, ${outputRegister.value}, ${outputValue.value}\n};`;
                }
                rulePreview.innerHTML = preview;
              }

              function newRuleProcessInput() {
                updateRulePreview();

                if (joinActive) {
                  if (inputType2.value == "Select" || Number(inputRegister2.value) < 0 || inputRegister2.value === "" || op2.value == "Select" || Number(compareValue2) < 0 || compareValue2.value === "") {
                    ruleSubmit.classList.add("d-none");
                    return;
                  }
                }

                if (inputType1.value == "Select" || Number(inputRegister1.value) < 0 || inputRegister1.value === "" || op1.value == "Select" || Number(compareValue1) < 0 || compareValue1.value === "" || outputType.value == "Select" || Number(outputRegister.value) < 0 || outputRegister.value === "" || Number(outputValue.value) < 0 || outputValue.value === "") {
                  ruleSubmit.classList.add("d-none");
                  return;
                }

                ruleSubmit.classList.remove("d-none");
              }

              ruleNew.addEventListener('click', () => {
                ruleNew.classList.add("d-none");
                ruleNewIf1.classList.remove("d-none");
                ruleNewOutput.classList.remove("d-none");
                rulePreviewArea.classList.remove("d-none");
                ruleCancel.classList.remove("d-none");
                ruleStatus.innerHTML = "";
              });

              ruleAddJoin.addEventListener('click', () => {
                if (!joinActive) {
                  ruleJoinDiv.classList.remove("d-none");
                  ruleNewIf2.classList.remove("d-none");
                  ruleSubmit.classList.add("d-none");
                  joinActive = true;
                  newRuleProcessInput();

                  ruleAddJoin.innerText = "Remove Join";
                  ruleAddJoin.classList.remove("btn-primary");
                  ruleAddJoin.classList.add("btn-danger");
                } else {
                  ruleJoinDiv.classList.add("d-none");
                  ruleNewIf2.classList.add("d-none");
                  joinActive = false;
                  newRuleProcessInput();

                  ruleAddJoin.innerText = "Add Join";
                  ruleAddJoin.classList.add("btn-primary");
                  ruleAddJoin.classList.remove("btn-danger");
                }
              });

              function getJoinIndex(joinString) {
                switch (joinString.toLowerCase()) {
                  case "and": return 2;
                  case "or": return 3;
                  default: return 0;
                }
              }

              function getJoinStringFromIndex(joinIndex) {
                switch (joinIndex) {
                  case 2: return "LOGIC_AND";
                  case 3: return "LOGIC_OR";
                  default: return "LOGIC_NONE";
                }
              }

              function getTypeIndex(typeString) {
                switch (typeString.toLowerCase()) {
                  case "coil": return 1;
                  case "discrete input": return 2;
                  case "holding register": return 3;
                  case "input register": return 4;
                  case "virtual coil": return 5;
                  case "virtual holding register": return 6;
                  default: return 0;
                }
              }

              function getTypeStringFromIndex(typeIndex) {
                switch (typeIndex) {
                  case 1: return "COIL";
                  case 2: return "DISCRETE";
                  case 3: return "HOLDING";
                  case 4: return "INPUT";
                  case 5: return "VIR_COIL";
                  case 6: return "VIR_HOLDING";
                  default: return "NULL";
                }
              }

              function getOperationIndex(operationString) {
                switch (operationString.toLowerCase()) {
                  case "==": return 1;
                  case "!=": return 2;
                  case ">": return 3;
                  case "<": return 4;
                  case ">=": return 5;
                  case "<=": return 6;
                  default: return 0;
                }
              }

              function getOperationStringFromIndex(operationIndex) {
                switch (operationIndex) {
                  case 1: return "CMP_EQ";
                  case 2: return "CMP_NEQ";
                  case 3: return "CMP_GT";
                  case 4: return "CMP_LT";
                  case 5: return "CMP_GTET";
                  case 6: return "CMP_LTET";
                  default: return "NULL";
                }
              }

              ruleSubmit.addEventListener('click', async () => {
                try {
                  ruleStatus.textContent = 'Sending request...';

                  let url;
                  if (joinActive) {
                    url = `/addrule?input_type1=${getTypeIndex(inputType1.value)}&input_reg1=${inputRegister1.value}&op1=${getOperationIndex(op1.value)}&compare_value1=${compareValue1.value}&input_type2=${getTypeIndex(inputType2.value)}&input_reg2=${inputRegister2.value}&op2=${getOperationIndex(op2.value)}&compare_value2=${compareValue2.value}&join=${getJoinIndex(ruleJoin.value)}&output_type=${getTypeIndex(outputType.value)}&output_reg=${outputRegister.value}&output_value=${outputValue.value}`;
                  } else {
                    url = `/addrule?input_type1=${getTypeIndex(inputType1.value)}&input_reg1=${inputRegister1.value}&op1=${getOperationIndex(op1.value)}&compare_value1=${compareValue1.value}&input_type2=0&input_reg2=0&op2=0&compare_value2=0&join=1&output_type=${getTypeIndex(outputType.value)}&output_reg=${outputRegister.value}&output_value=${outputValue.value}`;
                  }
                  
                  const response = await fetch(url);
                  const data = await response.json();

                  if (response.ok) {
                    ruleStatus.innerHTML = newStatus("alert-success", `Successfully added the rule.`);

                    ruleCleanup();
                    ruleListUpdate();
                  } else {
                    ruleStatus.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
                  }
                } catch (err) {
                    ruleStatus.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
                }
              });

              function ruleCleanup() {
                // Clean up
                
                ruleNew.classList.remove("d-none");
                ruleNewIf1.classList.add("d-none");
                ruleNewOutput.classList.add("d-none");
                ruleNewIf2.classList.add("d-none");
                rulePreviewArea.classList.add("d-none");
                rulePreview.innerHTML = "";

                ruleCancel.classList.add("d-none");

                inputType1.selectedIndex = 0;
                inputType2.selectedIndex = 0;
                inputRegister1.value = "";
                inputRegister2.value = "";
                op1.selectedIndex = 0;
                op2.selectedIndex = 0;
                compareValue1.value = "";
                compareValue2.value = "";
                outputType.selectedIndex = 0;
                outputRegister.value = "";
                outputValue.value = "";
                ruleJoin.selectedIndex = 0;

                ruleStatus.innerHTML = "";
                
                joinActive = false;
                ruleAddJoin.innerText = "Add Join";
                ruleAddJoin.classList.add("btn-primary");
                ruleAddJoin.classList.remove("btn-danger");

                ruleJoinDiv.classList.add("d-none");

                ruleSubmit.classList.add("d-none");
              }

              ruleCancel.addEventListener('click', () => {
                ruleCleanup();
              });

              async function ruleCountUpdate() {
                if (isConnected) {
                  let url = "/getrulecount";
                  const response = await fetch(url);
                  const data = await response.json();
                  ruleCountNum = parseInt(data.data);
                  let ruleText = "rule is";
                  if (ruleCountNum > 1 || ruleCountNum == 0) ruleText = "rules are";
                  ruleCount.innerText = `${ruleCountNum} ${ruleText} active.`;
                } else {
                  ruleCount.innerText = "Please initiate a serial connection to view device status.";
                }
              }

              async function ruleListUpdate() {
                // Pause status polling as this repeated modbus TX and RX can take some time
                await statusPolling(false);

                ruleToDelete = null;
                ruleListDelete.classList.add("d-none");
                
                ruleListRefresh.classList.add("d-none");
                ruleListRefreshBusy.classList.remove("d-none");

                let ruleListStatusBuffer = "";
                ruleList.innerHTML = "";
                ruleListArray.length = 0;

                if (isConnected) {
                  await ruleCountUpdate();
                  ruleListStatus.innerHTML = '';
                  for (let i = 0; i < ruleCountNum; i++) {
                    // Actually store the rule data
                    let url = `/getrule?index=${i}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!response.ok) {
                      ruleListStatusBuffer = ruleListStatusBuffer + `Error: ${data.error || 'Unknown error'}<br>`;
                      continue;
                    }

                    ruleListArray.push(data);
                    
                    // Update the ruleList
                    const item = document.createElement("button");
                    item.className = "list-group-item list-group-item-action";
                    item.textContent = `Rule ${i}`;
                    item.addEventListener("click", () => viewRule(i));
                    ruleList.appendChild(item);
                  }
                

                  if (ruleListArray.length != ruleCountNum) {
                    ruleListStatusBuffer = ruleListStatusBuffer + `Error: The number of successfully read rules does not equal the reported number of rules.<br><br><b>If graph polling is active, try stopping it temporarily. If another instance (browser tab) of the web panel is open, it's status update requests (and if active, graph polling requests) will likely interfere.</b><br>`;
                  }

                  if (ruleListStatusBuffer != "") {
                    ruleListStatus.innerHTML = newStatus("alert-danger", `${ruleListStatusBuffer}`);
                    ruleList.innerHTML = "";
                  }

                  await statusPolling(true);

                  ruleListRefresh.classList.remove("d-none");
                  ruleListRefreshBusy.classList.add("d-none");
                }
              }

              function viewRule(index) {
                if (index >= ruleListArray.length) {
                  ruleToDelete = null;
                  return;
                }

                ruleToDelete = index;
                ruleListDelete.classList.remove("d-none");
                
                ruleListViewAreaLabel.innerHTML = `<b>Viewing Rule ${index}:</b>`;
                ruleListViewArea.classList.remove("d-none");

                const ruleData = ruleListArray[index].data;

                let preview;
                if (parseInt(ruleData.joinRaw) != 1) {
                  preview = `rule = (LogicRule){\n\tREG_${getTypeStringFromIndex(ruleData.input_type1Raw)}, ${ruleData.input_reg1}, ${getOperationStringFromIndex(ruleData.op1Raw)}, ${ruleData.compare_value1},\n\tREG_${getTypeStringFromIndex(ruleData.input_type2Raw)}, ${ruleData.input_reg2}, ${getOperationStringFromIndex(ruleData.op2Raw)}, ${ruleData.compare_value2},\n\tLOGIC_${getJoinStringFromIndex(ruleData.joinRaw)},\n\tREG_${getTypeStringFromIndex(ruleData.output_typeRaw)}, ${ruleData.output_reg}, ${ruleData.output_value}\n};`;
                } else {
                  preview = `rule = (LogicRule){\n\tREG_${getTypeStringFromIndex(ruleData.input_type1Raw)}, ${ruleData.input_reg1}, ${getOperationStringFromIndex(ruleData.op1Raw)}, ${ruleData.compare_value1},\n\tREG_${getTypeStringFromIndex(ruleData.output_typeRaw)}, ${ruleData.output_reg}, ${ruleData.output_value}\n};`;
                }
                ruleListViewAreaContent.innerHTML = preview;
              }

              confirmDeleteRuleButton.addEventListener('click', () => {
                if (ruleToDelete !== null) {
                  deleteRule(ruleToDelete);

                  ruleToDelete = null;
                  bootstrap.Modal.getInstance(document.getElementById('confirmDeleteRuleModal')).hide();
                }
              });

              async function deleteRule(index) {
                try{
                  if (isConnected) {
                    let url = `/deleterule?index=${index}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (response.ok) {
                      await ruleListUpdate();
                      ruleListStatus.innerHTML = newStatus("alert-success", `Successfully deleted the rule with ID=${index}`);
                      ruleListViewArea.classList.add("d-none");
                    } else {
                      ruleListStatus.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
                    }
                  } else {
                    ruleListStatus.innerText = "No serial connection is currently active.";
                  }
                } catch (err) {
                    ruleStatus.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
                }
              }

              inputType1.addEventListener('change', () => newRuleProcessInput());
              inputType2.addEventListener('change', () => newRuleProcessInput());
              inputRegister1.addEventListener('input', () => newRuleProcessInput());
              inputRegister2.addEventListener('input', () => newRuleProcessInput());
              op1.addEventListener('change', () => newRuleProcessInput());
              op2.addEventListener('change', () => newRuleProcessInput());
              compareValue1.addEventListener('input', () => newRuleProcessInput());
              compareValue2.addEventListener('input', () => newRuleProcessInput());
              outputType.addEventListener('change', () => newRuleProcessInput());
              outputRegister.addEventListener('input', () => newRuleProcessInput());
              outputValue.addEventListener('input', () => newRuleProcessInput());
              ruleJoin.addEventListener('change', () => newRuleProcessInput());

              ruleListDelete.addEventListener('click', () => modalRTD.show());

              ruleListRefresh.addEventListener('click', () => {
                ruleListUpdate();
                ruleListViewAreaContent.innerHTML = "";
                ruleListViewArea.classList.add("d-none");
              });
            </script>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="tab-virtual" role="tabpanel">
        <!-- Virtual Registers -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Virtual Registers</h5>
            <a class="btn btn-link" data-bs-toggle="collapse" href="#virtualBody">Toggle</a>
          </div>
          <div id="virtualBody" class="collapse show">
            <div class="card m-3">
              <div class="card-body">
                <div class="mb-3">
                  <h6>Statistics</h6>
                  <span id="vrCount">Unknown number</span>
                </div>
              </div>
            </div>
            <div class="card m-3">
              <div class="card-body">
                <div id="vrManagerBody" class="collapse show">
                  <div class="mb-3">
                    <h6>Virtual Register Manager</h6>
                  </div>
                  <button id="vrNew" class="btn btn-primary d-inline-block">New</button>

                  <!-- New Rule If 1 -->
                  <div id="vrNewControls" class="mb-3 d-none">

                    <span>Type:</span>

                    <div class="d-inline-block me-2" style="width: 150px;">
                      <select id="vrNewType" class="form-select form-select-sm">
                        <option>Select</option>
                        <option>Coil</option>
                        <option>Holding Register</option>
                      </select>
                    </div>

                    <button id="vrNewSubmit" class="btn btn-secondary d-inline-block">Add</button>&nbsp;&nbsp;
                  </div>

                  <div id="vrNewStatus" class="mt-3"></div>
                </div>
              </div>
            </div>

            <div class="card m-3">
              <div class="card-body">
                <div id="activevrBody" class="collapse show">
                  <div class="mb-3">
                    <h6>Virtual Registers</h6>
                  </div>

                  <div class="list-group mb-3" id="vrList">
                    <!-- dynamically updated-->
                  </div>

                  <div id="vrListViewArea" class="card mb-3 d-none">
                    <div class="card-body">
                      <span id="vrListViewAreaLabel" class="mb-3">Virtual Register</span><br><br>
                      <div class="d-flex mb-2">
                        <!-- Read Section -->
                        <div class="d-flex align-items-center me-3">
                          <input type="number" class="form-control form-control-sm" id="vrListViewAreaValueRead" placeholder="value" min="0" readonly />
                          <button id="vrListViewAreaBtnRead" class="btn btn-primary ms-2">Read</button>
                        </div>
                        <!-- Write Section -->
                        <div class="d-flex align-items-center">
                          <input type="number" class="form-control form-control-sm" id="vrListViewAreaValueWrite" placeholder="value" min="0" />
                          <button id="vrListViewAreaBtnWrite" class="btn btn-primary ms-2">Write</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <button id="vrListRefresh" class="btn btn-primary d-inline-block">Refresh</button>
                  <button id="vrListRefreshBusy" class="btn btn-secondary d-inline-block d-none">Refresh</button>

                  <div id="vrListStatus" class="mt-3"></div>
                  <br>
                  <div class="alert alert-info" role="alert"><i class="fas fa-circle-info"></i>&nbsp;&nbsp;Virtual registers current cannot be deleted as rules may reference them. This functionality is planned.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        const vrNew = document.getElementById('vrNew');
        const vrNewSubmit = document.getElementById('vrNewSubmit');
        const vrNewType = document.getElementById('vrNewType');
        const vrNewControls = document.getElementById('vrNewControls');
        const vrNewStatus = document.getElementById('vrNewStatus');

        const vrCount = document.getElementById('vrCount');
        const vrList = document.getElementById('vrList');
        const vrListRefresh = document.getElementById('vrListRefresh');
        const vrListRefreshBusy = document.getElementById('vrListRefreshBusy');
        const vrListStatus = document.getElementById('vrListStatus');

        const vrListViewArea = document.getElementById('vrListViewArea');
        const vrListViewAreaLabel = document.getElementById('vrListViewAreaLabel');
        const vrListViewAreaValueRead = document.getElementById('vrListViewAreaValueRead');
        const vrListViewAreaBtnRead = document.getElementById('vrListViewAreaBtnRead');
        const vrListViewAreaValueWrite = document.getElementById('vrListViewAreaValueWrite');
        const vrListViewAreaBtnWrite = document.getElementById('vrListViewAreaBtnWrite');

        let vrCountCoils = 0;
        let vrCountHolding = 0;

        let selectedvr = null;
        let selectedvrtype = null;

        vrNew.addEventListener('click', () => {
          vrNew.classList.add("d-none");
          vrNewControls.classList.remove("d-none");
        });

        vrNewType.addEventListener('change', () => {
          vrNewStatus.innerHTML = "";
          if (vrNewType.selectedIndex != 0) {
            vrNewSubmit.classList.remove("btn-secondary");
            vrNewSubmit.classList.add("btn-primary");
          } else {
            vrNewSubmit.classList.add("btn-secondary");
            vrNewSubmit.classList.remove("btn-primary");
          }
        });

        vrNewSubmit.addEventListener('click', async () => {
          vrNewStatus.innerHTML = "";
          if (vrNewSubmit.classList.contains("btn-secondary")) {
            vrNewStatus.innerHTML = newStatus("alert-warning", `Please select a register type.`);
            return;
          }
          const registerType = vrNewType.selectedIndex; // ensure index 0 is a placeholder, e.g., "select"
          await vrNewRequest(registerType);

          vrListUpdate();
        });

        async function vrNewRequest(registerType) {
          try {
            const url = `/addvr?type=${encodeURIComponent(registerType)}`;
            
            const response = await fetch(url);
            vrNewStatus.innerHTML = "";
            if (response.ok) {
              const data = await response.json();

              const statusmsg = `A virtual register of type ${vrNewType.value} was successfully created.`;
              vrNewStatus.innerHTML = newStatus("alert-success", statusmsg);

              // cleanup
              vrNewSubmit.classList.remove("btn-primary");
              vrNewSubmit.classList.add("btn-secondary");
              vrNewControls.classList.add("d-none");
              vrNewType.selectedIndex = 0;
              vrNew.classList.remove("d-none");
            } else {
              vrNewStatus.innerHTML = newStatus("alert-danger", `Error: ${data.error || 'Unknown error'}`);
            }
          } catch (err) {
              vrNewStatus.innerHTML = newStatus("alert-danger", `Server error: ${err.message}`);
          }
        }

        async function vrCountUpdate() {
          if (isConnected) {
            let url = `/countvr?type=1`; // coils count
            let url2 = `/countvr?type=2`; // holding count

            let response = await fetch(url);
            let data = await response.json();
            vrCountCoils = parseInt(data.count);

            response = await fetch(url2);
            data = await response.json();
            vrCountHolding = parseInt(data.count);

            let coilsText = (vrCountCoils == 1 ?  "virtual coil." : "virtual coils."); // non plural / plural
            let holdingText = (vrCountHolding == 1 ?  "virtual holding register." : "virtual holding registers."); // non plural / plural
            vrCount.innerHTML = `${vrCountCoils} ${coilsText}<br>${vrCountHolding} ${holdingText}`;
          } else {
            ruleCount.innerText = "Please initiate a serial connection to view device status.";
          }
        }

        async function vrListUpdate() {
          // Pause status polling as this repeated modbus TX and RX can take some time
          await statusPolling(false);

          selectedvr = null;
          selectedvrtype = null;
          
          vrListRefresh.classList.add("d-none");
          vrListRefreshBusy.classList.remove("d-none");

          vrList.innerHTML = "";

          if (isConnected) {
            await vrCountUpdate();
            ruleListStatus.innerHTML = '';
            for (let i = 0; i < vrCountCoils; i++) {
              // Update the ruleList
              const item = document.createElement("button");
              item.className = "list-group-item list-group-item-action";
              item.textContent = `Virtual Coil ${i}`;
              item.addEventListener("click", () => viewvr(i, 1));
              vrList.appendChild(item);
            }
            for (let i = 0; i < vrCountHolding; i++) {
              // Update the ruleList
              const item = document.createElement("button");
              item.className = "list-group-item list-group-item-action";
              item.textContent = `Virtual Holding Register ${i}`;
              item.addEventListener("click", () => viewvr(i, 2));
              vrList.appendChild(item);
            }

            vrListViewArea.classList.add("d-none");
            
            await statusPolling(true);

            vrListRefresh.classList.remove("d-none");
            vrListRefreshBusy.classList.add("d-none");
          }
        }

        async function viewvr(i, type) {
          if (isNaN(i) || i < 0 ) {
            vrListStatus.innerHTML = newStatus("alert-danger", `Invalid stored virtual register address ${selectedvr}`);
          } else if (isNaN(type) || type < 1 || type > 2) {
            vrListStatus.innerHTML = newStatus("alert-danger", `Invalid stored virtual register type ${selectedvrtype}. Should only be 1 or 2.`);
            return;
          }

          selectedvr = i;
          selectedvrtype = type;

          vrListViewAreaValueRead.value = "";
          vrListViewAreaValueWrite.value = "";

          vrListViewArea.classList.remove("d-none");
          let typeText = (type == 1) ? "Coil" : "Holding Register";
          vrListViewAreaLabel.innerText = `Virtual ${typeText} ${i}:`;
        }

        vrListViewAreaBtnWrite.addEventListener('click', async () => {
          if (selectedvr == null || selectedvrtype == null) {
            return;
          }

          const value = parseInt(vrListViewAreaValueWrite.value);

          if (isNaN(value) || value < 0) {
            vrListStatus.innerHTML = newStatus("alert-danger", "Please provide a valid write value (for coils, 0 or 1; for holding registers, 0-65535).");
            return;
          }

          const url = `/writevr?type=${selectedvrtype}&address=${selectedvr}&value=${value}`;
          const response = await fetch(url);
          const data = await response.json();

          if (data.success == true) {
            vrListStatus.innerHTML = newStatus("alert-success", "Write successful.");
          } else {
            vrListStatus.innerHTML = newStatus("alert-danger", `Error: ${data.error}`);
          }
        });

        vrListViewAreaBtnRead.addEventListener('click', async () => {
          if (selectedvr == null || selectedvrtype == null) {
            return;
          }

          const url = `/readvr?type=${selectedvrtype}&address=${selectedvr}`;
          const response = await fetch(url);
          const data = await response.json();

          if (data.success == false) {
            vrListStatus.innerHTML = newStatus("alert-danger", `Error: ${data.error}`);
            return;
          }

          vrListViewAreaValueRead.value = data.value;
        });

        vrListRefresh.addEventListener('click', async () => {
          vrListUpdate();
          vrListViewArea.classList.add("d-none");
        });
      </script>


      <div class="tab-pane fade" id="tab-hardware" role="tabpanel">
        <!-- Hardware Configuration -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Hardware Configuration</h5>
            <a class="btn btn-link" data-bs-toggle="collapse" href="#hardwareBody">Toggle</a>
          </div>
          <div id="hardwareBody" class="collapse show">
            <div class="card m-3">
              <div class="card-body">
                <div class="mb-3">
                  <h6>Configure Analogue Modes</h6>
                  <span>AIN - Input Registers:</span>
                  AIN1
                  AIN2
                  AIN3
                  AIN4
                  <span>AOUT - Holding Registers:</span>
                  AOUT1
                  AOUT2
                </div>
              </div>
            </div>
            <div class="card m-3">
              <div class="card-body">
                <div id="vrManagerBody" class="collapse show">
                  <div class="mb-3">
                    <h6>Virtual Register Manager</h6>
                  </div>
                  <button id="vrNew" class="btn btn-primary d-inline-block">New</button>

                  <!-- New Rule If 1 -->
                  <div id="vrNewControls" class="mb-3 d-none">

                    <span>Type:</span>

                    <div class="d-inline-block me-2" style="width: 150px;">
                      <select id="vrNewType" class="form-select form-select-sm">
                        <option>Select</option>
                        <option>Coil</option>
                        <option>Holding Register</option>
                      </select>
                    </div>

                    <button id="vrNewSubmit" class="btn btn-secondary d-inline-block">Add</button>&nbsp;&nbsp;
                  </div>

                  <div id="vrNewStatus" class="mt-3"></div>
                </div>
              </div>
            </div>

            <div class="card m-3">
              <div class="card-body">
                <div id="activevrBody" class="collapse show">
                  <div class="mb-3">
                    <h6>Virtual Registers</h6>
                  </div>

                  <div class="list-group mb-3" id="vrList">
                    <!-- dynamically updated-->
                  </div>

                  <div id="vrListViewArea" class="card mb-3 d-none">
                    <div class="card-body">
                      <span id="vrListViewAreaLabel" class="mb-3">Virtual Register</span><br><br>
                      <div class="d-flex mb-2">
                        <!-- Read Section -->
                        <div class="d-flex align-items-center me-3">
                          <input type="number" class="form-control form-control-sm" id="vrListViewAreaValueRead" placeholder="value" min="0" readonly />
                          <button id="vrListViewAreaBtnRead" class="btn btn-primary ms-2">Read</button>
                        </div>
                        <!-- Write Section -->
                        <div class="d-flex align-items-center">
                          <input type="number" class="form-control form-control-sm" id="vrListViewAreaValueWrite" placeholder="value" min="0" />
                          <button id="vrListViewAreaBtnWrite" class="btn btn-primary ms-2">Write</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <button id="vrListRefresh" class="btn btn-primary d-inline-block">Refresh</button>
                  <button id="vrListRefreshBusy" class="btn btn-secondary d-inline-block d-none">Refresh</button>

                  <div id="vrListStatus" class="mt-3"></div>
                  <br>
                  <div class="alert alert-info" role="alert"><i class="fas fa-circle-info"></i>&nbsp;&nbsp;Virtual registers current cannot be deleted as rules may reference them. This functionality is planned.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- WINDOW ON LOAD -->
<script>
  window.onload = async function () {
    await fetchPorts();
    await getStatus();
    if (isConnected) {
      updateUI(true, currentPort, currentSlave);
      statusPolling(true);
    }
    await ruleListUpdate();
    await vrListUpdate();
  };
</script>
  
</body>
</html>
